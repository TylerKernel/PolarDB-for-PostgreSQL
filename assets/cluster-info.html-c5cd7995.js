import{_ as c,r as p,o as i,c as k,d as s,a,w as o,b as n,e as d}from"./app-eb0c2f94.js";const u="/PolarDB-for-PostgreSQL/assets/cluster_info_generate-0c9329ce.png",m={},b=a("h1",{id:"集群拓扑视图",tabindex:"-1"},[a("a",{class:"header-anchor",href:"#集群拓扑视图","aria-hidden":"true"},"#"),n(" 集群拓扑视图")],-1),_={class:"table-of-contents"},h=d(`<h2 id="功能介绍" tabindex="-1"><a class="header-anchor" href="#功能介绍" aria-hidden="true">#</a> 功能介绍</h2><p>PolarDB for PostgreSQL 的 ePQ 弹性跨机并行查询功能可以将一个大查询分散到多个节点上执行，从而加快查询速度。该功能会涉及到各个节点之间的通信，包括执行计划的分发、执行的控制、结果的获取等等。因此设计了 <strong>集群拓扑视图</strong> 功能，用于为 ePQ 组件收集并展示集群的拓扑信息，实现跨节点查询。</p><h2 id="术语" tabindex="-1"><a class="header-anchor" href="#术语" aria-hidden="true">#</a> 术语</h2><ul><li>RW / Primary：读写节点，后统称为 Primary</li><li>RO / Replica：只读节点，后统称为 Replica</li><li>Standby：灾备节点</li><li>Replication Slot：流复制槽，PostgreSQL 中用于持久化流复制关系的机制</li></ul><h2 id="功能使用" tabindex="-1"><a class="header-anchor" href="#功能使用" aria-hidden="true">#</a> 功能使用</h2><p>集群拓扑视图的维护是完全透明的，用户只需要按照部署文档搭建一写多读的集群，集群拓扑视图即可正确维护起来。关键在于需要搭建带有流复制槽的 Replica / Standby 节点。</p><p>使用以下接口可以获取集群拓扑视图（执行结果来自于 PolarDB for PostgreSQL 11）：</p><div class="language-sql" data-ext="sql"><pre class="language-sql"><code>postgres<span class="token operator">=</span><span class="token comment"># SELECT * FROM polar_cluster_info;</span>
 name  <span class="token operator">|</span>   host    <span class="token operator">|</span> port <span class="token operator">|</span> release_date <span class="token operator">|</span> version <span class="token operator">|</span> slot_name <span class="token operator">|</span>  <span class="token keyword">type</span>   <span class="token operator">|</span> state <span class="token operator">|</span> cpu <span class="token operator">|</span> cpu_quota <span class="token operator">|</span> memory <span class="token operator">|</span> memory_quota <span class="token operator">|</span> iops <span class="token operator">|</span> iops_quota <span class="token operator">|</span> connection <span class="token operator">|</span> connection_quota <span class="token operator">|</span> px_connection <span class="token operator">|</span> px_connection_quota <span class="token operator">|</span> px_node
<span class="token comment">-------+-----------+------+--------------+---------+-----------+---------+-------+-----+-----------+--------+--------------+------+------------+------------+------------------+---------------+---------------------+---------</span>
 node0 <span class="token operator">|</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">|</span> <span class="token number">5432</span> <span class="token operator">|</span> <span class="token number">20220930</span>     <span class="token operator">|</span> <span class="token number">1.1</span><span class="token number">.27</span>  <span class="token operator">|</span>           <span class="token operator">|</span> RW      <span class="token operator">|</span> Ready <span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span>         <span class="token number">0</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>            <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>                <span class="token number">0</span> <span class="token operator">|</span>             <span class="token number">0</span> <span class="token operator">|</span>                   <span class="token number">0</span> <span class="token operator">|</span> f
 node1 <span class="token operator">|</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">|</span> <span class="token number">5433</span> <span class="token operator">|</span> <span class="token number">20220930</span>     <span class="token operator">|</span> <span class="token number">1.1</span><span class="token number">.27</span>  <span class="token operator">|</span> replica1  <span class="token operator">|</span> RO      <span class="token operator">|</span> Ready <span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span>         <span class="token number">0</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>            <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>                <span class="token number">0</span> <span class="token operator">|</span>             <span class="token number">0</span> <span class="token operator">|</span>                   <span class="token number">0</span> <span class="token operator">|</span> t
 node2 <span class="token operator">|</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">|</span> <span class="token number">5434</span> <span class="token operator">|</span> <span class="token number">20220930</span>     <span class="token operator">|</span> <span class="token number">1.1</span><span class="token number">.27</span>  <span class="token operator">|</span> replica2  <span class="token operator">|</span> RO      <span class="token operator">|</span> Ready <span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span>         <span class="token number">0</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>            <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>                <span class="token number">0</span> <span class="token operator">|</span>             <span class="token number">0</span> <span class="token operator">|</span>                   <span class="token number">0</span> <span class="token operator">|</span> t
 node3 <span class="token operator">|</span> <span class="token number">127.0</span><span class="token number">.0</span><span class="token number">.1</span> <span class="token operator">|</span> <span class="token number">5431</span> <span class="token operator">|</span> <span class="token number">20220930</span>     <span class="token operator">|</span> <span class="token number">1.1</span><span class="token number">.27</span>  <span class="token operator">|</span> standby1  <span class="token operator">|</span> Standby <span class="token operator">|</span> Ready <span class="token operator">|</span>   <span class="token number">0</span> <span class="token operator">|</span>         <span class="token number">0</span> <span class="token operator">|</span>      <span class="token number">0</span> <span class="token operator">|</span>            <span class="token number">0</span> <span class="token operator">|</span>    <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>          <span class="token number">0</span> <span class="token operator">|</span>                <span class="token number">0</span> <span class="token operator">|</span>             <span class="token number">0</span> <span class="token operator">|</span>                   <span class="token number">0</span> <span class="token operator">|</span> f
<span class="token punctuation">(</span><span class="token number">4</span> <span class="token keyword">rows</span><span class="token punctuation">)</span>
</code></pre></div><ul><li><code>name</code> 是节点的名称，是自动生成的。</li><li><code>host</code> / <code>port</code> 表示了节点的连接信息。在这里，都是本地地址。</li><li><code>release_date</code> 和 <code>version</code> 标识了 PolarDB 的版本信息。</li><li><code>slot_name</code> 是节点连接所使用的流复制槽，只有使用流复制槽连接上来的节点才会被统计在该视图中（除 Primary 节点外）。</li><li><code>type</code> 表示节点的类型，有三类： <ul><li>PolarDB for PostgreSQL 11：RW / RO / Standby</li><li>PolarDB for PostgreSQL 14：Primary / Replica / Standby</li></ul></li><li><code>state</code> 表示节点的状态。有 Offline / Going Offline / Disabled / Initialized / Pending / Ready / Unknown 这些状态，其中只有 Ready 才有可能参与 PX 计算，其他的都无法参与 PX 计算。</li><li><code>px_node</code> 表示是否参与 PX 计算。</li><li>后续字段都是性能采集相关的字段，目前都是留空的。</li></ul><p>对于 ePQ 查询来说，默认只有 Replica 节点参与。可以通过参数控制使用 Primary 节点或者 Standby 节点参与计算：</p><div class="language-sql" data-ext="sql"><pre class="language-sql"><code><span class="token comment">-- 使 Primary 节点参与计算</span>
<span class="token keyword">SET</span> polar_px_use_master <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span>

<span class="token comment">-- 使 Standby 节点参与计算</span>
<span class="token keyword">SET</span> polar_px_use_standby <span class="token operator">=</span> <span class="token keyword">ON</span><span class="token punctuation">;</span>
</code></pre></div><div class="custom-container tip"><p class="custom-container-title">提示</p><p>从 PolarDB for PostgreSQL 14 起，<code>polar_px_use_master</code> 参数改名为 <code>polar_px_use_primary</code>。</p></div><p>还可以使用 <code>polar_px_nodes</code> 指定哪些节点参与 PX 计算。例如使用上述集群拓扑视图，可以执行如下命令，让 PX 查询只在 replica1 上执行。</p><div class="language-sql" data-ext="sql"><pre class="language-sql"><code><span class="token keyword">SET</span> polar_px_nodes <span class="token operator">=</span> <span class="token string">&#39;node1&#39;</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="设计实现" tabindex="-1"><a class="header-anchor" href="#设计实现" aria-hidden="true">#</a> 设计实现</h2><h3 id="信息采集" tabindex="-1"><a class="header-anchor" href="#信息采集" aria-hidden="true">#</a> 信息采集</h3><p>集群拓扑视图信息的采集是通过流复制来传递信息的。该功能对流复制协议增加了新的消息类型用于集群拓扑视图的传递。分为以下两个步骤：</p><ul><li>Replica / Standby 将状态传递给 Primary</li><li>Primary 汇总集群拓扑视图，返回给 Replica / Standby</li></ul><h3 id="更新频率" tabindex="-1"><a class="header-anchor" href="#更新频率" aria-hidden="true">#</a> 更新频率</h3><p>集群拓扑视图并非定时更新与发送，因为视图并非一直变化。只有当节点刚启动时，或发生关键状态变化时再进行更新发送。</p><p>在具体实现上，Primary 节点收集的全局状态带有版本 generation，只有在接收到节点拓扑变化才会递增；当全局状态版本更新后，才会发送到其他节点，其他节点接收到后，设置到自己的节点上。</p><p><img src="`+u+'" alt="生成集群拓扑视图"></p><h3 id="采集维度" tabindex="-1"><a class="header-anchor" href="#采集维度" aria-hidden="true">#</a> 采集维度</h3><p>状态指标：</p><ul><li>节点 name</li><li>节点 host / port</li><li>节点 slot_name</li><li>节点负载（CPU / MEM / 连接 / IOPS）</li><li>节点状态 <ul><li>Offline</li><li>Going Offline</li><li>Disabled</li><li>Initialized</li><li>Pending</li><li>Ready</li><li>Unknown</li></ul></li></ul><h3 id="消息格式" tabindex="-1"><a class="header-anchor" href="#消息格式" aria-hidden="true">#</a> 消息格式</h3><p>同 WAL Sender / WAL Reciver 的其他消息的做法，新增 <code>&#39;m&#39;</code> 和 <code>&#39;M&#39;</code> 消息类型，用于收集节点信息和广播集群拓扑视图。</p><h3 id="内部使用" tabindex="-1"><a class="header-anchor" href="#内部使用" aria-hidden="true">#</a> 内部使用</h3><p>提供接口获取 Replica 列表，提供 IP / port 等信息，用于 PX 查询。</p><p>预留了较多的负载接口，可以根据负载来实现动态调整并行度。（尚未接入）</p><p>同时增加了参数 <code>polar_px_use_master</code> / <code>polar_px_use_standby</code>，将 Primary / Standby 加入到 PX 计算中，默认不打开（可能会有正确性问题，因为快照格式、Vacuum 等原因，快照有可能不可用）。</p><p>ePQ 会使用上述信息生成节点的连接信息并缓存下来，并在 ePQ 查询中使用该视图。当 generation 更新或者设置了 <code>polar_px_nodes</code> / <code>polar_px_use_master</code> / <code>polar_px_use_standby</code> 时，该缓存会被重置，并在下次使用时重新生成缓存。</p><h3 id="结果展示" tabindex="-1"><a class="header-anchor" href="#结果展示" aria-hidden="true">#</a> 结果展示</h3><p>通过 <code>polar_monitor</code> 插件提供视图，将上述集群拓扑视图提供出去，在任意节点均可获取。</p>',34);function f(t,y){const r=p("Badge"),l=p("ArticleInfo"),e=p("router-link");return i(),k("div",null,[b,s(r,{type:"tip",text:"V11 / v1.1.20-",vertical:"top"}),s(l,{frontmatter:t.$frontmatter},null,8,["frontmatter"]),a("nav",_,[a("ul",null,[a("li",null,[s(e,{to:"#功能介绍"},{default:o(()=>[n("功能介绍")]),_:1})]),a("li",null,[s(e,{to:"#术语"},{default:o(()=>[n("术语")]),_:1})]),a("li",null,[s(e,{to:"#功能使用"},{default:o(()=>[n("功能使用")]),_:1})]),a("li",null,[s(e,{to:"#设计实现"},{default:o(()=>[n("设计实现")]),_:1}),a("ul",null,[a("li",null,[s(e,{to:"#信息采集"},{default:o(()=>[n("信息采集")]),_:1})]),a("li",null,[s(e,{to:"#更新频率"},{default:o(()=>[n("更新频率")]),_:1})]),a("li",null,[s(e,{to:"#采集维度"},{default:o(()=>[n("采集维度")]),_:1})]),a("li",null,[s(e,{to:"#消息格式"},{default:o(()=>[n("消息格式")]),_:1})]),a("li",null,[s(e,{to:"#内部使用"},{default:o(()=>[n("内部使用")]),_:1})]),a("li",null,[s(e,{to:"#结果展示"},{default:o(()=>[n("结果展示")]),_:1})])])])])]),h])}const g=c(m,[["render",f],["__file","cluster-info.html.vue"]]);export{g as default};
